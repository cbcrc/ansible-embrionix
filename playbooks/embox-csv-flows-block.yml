# 
# These tasks are used by the embox-csv-flows.yml playbook
#
# Copyright: (c) 2018, Société Radio-Canada>
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
#
---
- name: Register box type
  emsfp_get_type_2:
    ip_addr: "{{module_item['ip_addr']}}"
  delegate_to: localhost
  register: embox_type

- name: "Upload flows '{{ module_item['Flow'] }}' configuration to embox6({{ module_item['ip_addr'] }})"
  emsfp_flows:
    ip_addr: "{{ module_item['ip_addr'] | default(None) }}"
    Target: "{{ module_item['ip_addr'] | default(None) }}"
    FlowType: "{{ module_item['FlowType'] | default(None) }}"
    Flow: "{{ module_item['Flow'] | default(None) }}"
    aud_chan_cnt: "{{ module_item['aud_chan_cnt'] | default(None) }}"
    aud_chan_map: "{{ module_item['aud_chan_map'] | default(None) }}"
    audio_mapping_ch0: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch1: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch2: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch3: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch4: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch5: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch6: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch7: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch8: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch9: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch10: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch11: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch12: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch13: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch14: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch15: "{{ module_item['ch0'] | default(None) }}"
    anc_flow_profile: "{{ module_item['anc_flow_profile'] | default(None) }}"
    aud_ptime_idx: "{{ module_item['aud_ptime_idx'] | default(None) }}"      
    dscp: "{{ module_item['dscp'] | default(None) }}"
    dst_ip_addr: "{{ module_item['dst_ip_addr'] | default(None) }}"
    dst_udp_port: "{{ module_item['dst_udp_port'] | default(None) }}"
    enable: "{{ module_item['enable'] | default(None) }}"
    igmp_src_ip: "{{ module_item['igmp_src_ip'] | default(None) }}"
    label: "{{ module_item['Label_pre'] | default(None) }}6{{ flow_item['label_suf'] | default(None) }}"
    name: "{{ module_item['name'] | default(None) }}"
    pkt_filter_dst_ip: "{{ module_item['pkt_filter_dst_ip'] | default(None) }}"
    pkt_filter_dst_udp: "{{ module_item['pkt_filter_dst_mac'] | default(None) }}"
    pkt_filter_dst_mac: "{{ module_item['pkt_filter_vlan'] | default(None) }}"
    pkt_filter_src_ip: "{{ module_item['pkt_filter_src_ip'] | default(None) }}"
    pkt_filter_src_udp: "{{ module_item['pkt_filter_src_udp'] | default(None) }}"
    pkt_filter_src_mac: "{{ module_item['pkt_filter_src_mac'] | default(None) }}"
    pkt_filter_ssrc: "{{ module_item['pkt_filter_ssrc'] | default(None) }}"
    pkt_filter_vlan: "{{ module_item['pkt_filter_ssrc'] | default(None) }}"
    rtp_pt: "{{ module_item['rtp_pt'] | default(None) }}"
    sender_type: "{{ module_item['sender_type'] | default(None) }}"
    src_ip_addr: "{{ module_item['src_ip_addr'] | default(None) }}"
    src_udp_port: "{{ module_item['src_udp_port'] | default(None) }}"
    # ssrc: "{{ module_item['ssrc'] | default(None) }}" #read only value
    vlan_tag: "{{ module_item['vlan_tag'] | default(None) }}"
  when:
    - embox_type.type == "Embox6_8"
    - module_item['ip_addr'] in reachable_hosts

- name: "Upload flows '{{ module_item['Flow'] }}' configuration to embox3({{ module_item['ip_addr'] }})"
  emsfp_flows:
    ip_addr: "{{ module_item['ip_addr'] | default(None) }}"
    Target: "{{ module_item['ip_addr'] | default(None) }}"
    FlowType: "{{ module_item['FlowType'] | default(None) }}"
    Flow: "{{ module_item['Flow'] | default(None) }}"
    aud_chan_cnt: "{{ module_item['aud_chan_cnt'] | default(None) }}"
    aud_chan_map: "{{ module_item['aud_chan_map'] | default(None) }}"
    audio_mapping_ch0: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch1: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch2: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch3: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch4: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch5: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch6: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch7: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch8: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch9: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch10: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch11: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch12: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch13: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch14: "{{ module_item['ch0'] | default(None) }}"
    audio_mapping_ch15: "{{ module_item['ch0'] | default(None) }}"
    anc_flow_profile: "{{ module_item['anc_flow_profile'] | default(None) }}"
    aud_ptime_idx: "{{ module_item['aud_ptime_idx'] | default(None) }}"      
    dscp: "{{ module_item['dscp'] | default(None) }}"
    dst_ip_addr: "{{ module_item['dst_ip_addr'] | default(None) }}"
    dst_udp_port: "{{ module_item['dst_udp_port'] | default(None) }}"
    enable: "{{ module_item['enable'] | default(None) }}"
    igmp_src_ip: "{{ module_item['igmp_src_ip'] | default(None) }}"
    label: "{{ module_item['Label_pre'] | default(None) }}3{{ flow_item['label_suf'] | default(None) }}"
    name: "{{ module_item['name'] | default(None) }}"
    pkt_filter_dst_ip: "{{ module_item['pkt_filter_dst_ip'] | default(None) }}"
    pkt_filter_dst_udp: "{{ module_item['pkt_filter_dst_mac'] | default(None) }}"
    pkt_filter_dst_mac: "{{ module_item['pkt_filter_vlan'] | default(None) }}"
    pkt_filter_src_ip: "{{ module_item['pkt_filter_src_ip'] | default(None) }}"
    pkt_filter_src_udp: "{{ module_item['pkt_filter_src_udp'] | default(None) }}"
    pkt_filter_src_mac: "{{ module_item['pkt_filter_src_mac'] | default(None) }}"
    pkt_filter_ssrc: "{{ module_item['pkt_filter_ssrc'] | default(None) }}"
    pkt_filter_vlan: "{{ module_item['pkt_filter_ssrc'] | default(None) }}"
    rtp_pt: "{{ module_item['rtp_pt'] | default(None) }}"
    sender_type: "{{ module_item['sender_type'] | default(None) }}"
    src_ip_addr: "{{ module_item['src_ip_addr'] | default(None) }}"
    src_udp_port: "{{ module_item['src_udp_port'] | default(None) }}"
    # ssrc: "{{ flow_item['ssrc'] | default(None) }}" #read only value
    vlan_tag: "{{ module_item['vlan_tag'] | default(None) }}"
  when:
    - embox_type.type == "box3u_25G"
    - "flow_idx|int < 24"
    - module_item['ip_addr'] in reachable_hosts
