# 
# These tasks are used by the embox-csv-flows.yml playbook
#
# Copyright: (c) 2018, Société Radio-Canada>
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
#
---
- name: Register box type
  emsfp_get_type_2:
    ip_addr: "{{module_item['ip_addr_red']}}"
  delegate_to: localhost
  register: embox_type

# - debug:
#     msg: "Label: {{ module_item['Label_pre'] | default(None) }}{{ flow_item['label_suf'] | default(None) }}"
#   loop: "{{ modules_flows_config }}"
#   loop_control:
#     loop_var: flow_item
#   when: embox_type.type == "Embox6"

- name: Upload flows configuration to embox6
  emsfp_flows:
    ip_addr: "{{ module_item['ip_addr_red'] | default(None) }}"
    Target: "{{ module_item['ip_addr_red'] | default(None) }}"
    FlowType: "{{ flow_item['FlowType'] | default(None) }}"
    Flow: "{{ flow_item['Flow'] | default(None) }}"
    aud_chan_cnt: "{{ flow_item['aud_chan_cnt'] | default(None) }}"
    aud_chan_map: "{{ flow_item['aud_chan_map'] | default(None) }}"
    anc_flow_profile: "{{ flow_item['anc_flow_profile'] | default(None) }}"
    aud_ptime_idx: "{{ flow_item['aud_ptime_idx'] | default(None) }}"      
    dscp: "{{ flow_item['dscp'] | default(None) }}"
    dst_ip_addr: "{{ flow_item['dst_ip_addr'] | default(None) }}"
    dst_udp_port: "{{ flow_item['dst_udp_port'] | default(None) }}"
    enable: "{{ flow_item['enable'] | default(None) }}"
    igmp_src_ip: "{{ flow_item['igmp_src_ip'] | default(None) }}"
    label: "{{ module_item['Label_pre'] | default(None) }}6{{ flow_item['label_suf'] | default(None) }}"
    name: "{{ flow_item['name'] | default(None) }}"
    pkt_filter_dst_ip: "{{ flow_item['pkt_filter_dst_ip'] | default(None) }}"
    pkt_filter_dst_udp: "{{ flow_item['pkt_filter_dst_mac'] | default(None) }}"
    pkt_filter_dst_mac: "{{ flow_item['pkt_filter_vlan'] | default(None) }}"
    pkt_filter_src_ip: "{{ flow_item['pkt_filter_src_ip'] | default(None) }}"
    pkt_filter_src_udp: "{{ flow_item['pkt_filter_src_udp'] | default(None) }}"
    pkt_filter_src_mac: "{{ flow_item['pkt_filter_src_mac'] | default(None) }}"
    pkt_filter_ssrc: "{{ flow_item['pkt_filter_ssrc'] | default(None) }}"
    pkt_filter_vlan: "{{ flow_item['pkt_filter_ssrc'] | default(None) }}"
    rtp_pt: "{{ flow_item['rtp_pt'] | default(None) }}"
    sender_type: "{{ flow_item['sender_type'] | default(None) }}"
    src_ip_addr: "{{ flow_item['src_ip_addr'] | default(None) }}"
    src_udp_port: "{{ flow_item['src_udp_port'] | default(None) }}"
    # ssrc: "{{ flow_item['ssrc'] | default(None) }}" #read only value
    vlan_tag: "{{ flow_item['vlan_tag'] | default(None) }}"
  loop: "{{ modules_flows_config }}"
  loop_control:
    loop_var: flow_item
  when: embox_type.type == "Embox6_8"

# - debug:
#     msg: "Label: {{ module_item['Label_pre'] | default(None) }}{{ flow_item['label_suf'] | default(None) }}"
#   loop: "{{ modules_flows_config }}"
#   when:
#     - embox_type.type == "Embox3"
#     - "flow_idx|int < 24"
#   loop_control:
#     loop_var: flow_item
#     index_var: flow_idx


- name: Upload flows configuration to embox3
  emsfp_flows:
    ip_addr: "{{ module_item['ip_addr_red'] | default(None) }}"
    Target: "{{ module_item['ip_addr_red'] | default(None) }}"
    FlowType: "{{ flow_item['FlowType'] | default(None) }}"
    Flow: "{{ flow_item['Flow'] | default(None) }}"
    aud_chan_cnt: "{{ flow_item['aud_chan_cnt'] | default(None) }}"
    aud_chan_map: "{{ flow_item['aud_chan_map'] | default(None) }}"
    anc_flow_profile: "{{ flow_item['anc_flow_profile'] | default(None) }}"
    aud_ptime_idx: "{{ flow_item['aud_ptime_idx'] | default(None) }}"      
    dscp: "{{ flow_item['dscp'] | default(None) }}"
    dst_ip_addr: "{{ flow_item['dst_ip_addr'] | default(None) }}"
    dst_udp_port: "{{ flow_item['dst_udp_port'] | default(None) }}"
    enable: "{{ flow_item['enable'] | default(None) }}"
    igmp_src_ip: "{{ flow_item['igmp_src_ip'] | default(None) }}"
    label: "{{ module_item['Label_pre'] | default(None) }}3{{ flow_item['label_suf'] | default(None) }}"
    name: "{{ flow_item['name'] | default(None) }}"
    pkt_filter_dst_ip: "{{ flow_item['pkt_filter_dst_ip'] | default(None) }}"
    pkt_filter_dst_udp: "{{ flow_item['pkt_filter_dst_mac'] | default(None) }}"
    pkt_filter_dst_mac: "{{ flow_item['pkt_filter_vlan'] | default(None) }}"
    pkt_filter_src_ip: "{{ flow_item['pkt_filter_src_ip'] | default(None) }}"
    pkt_filter_src_udp: "{{ flow_item['pkt_filter_src_udp'] | default(None) }}"
    pkt_filter_src_mac: "{{ flow_item['pkt_filter_src_mac'] | default(None) }}"
    pkt_filter_ssrc: "{{ flow_item['pkt_filter_ssrc'] | default(None) }}"
    pkt_filter_vlan: "{{ flow_item['pkt_filter_ssrc'] | default(None) }}"
    rtp_pt: "{{ flow_item['rtp_pt'] | default(None) }}"
    sender_type: "{{ flow_item['sender_type'] | default(None) }}"
    src_ip_addr: "{{ flow_item['src_ip_addr'] | default(None) }}"
    src_udp_port: "{{ flow_item['src_udp_port'] | default(None) }}"
    # ssrc: "{{ flow_item['ssrc'] | default(None) }}" #read only value
    vlan_tag: "{{ flow_item['vlan_tag'] | default(None) }}"
  loop: "{{ modules_flows_config }}"
  when:
    - embox_type.type == "box3u_25G"
    - "flow_idx|int < 24"
  loop_control:
    loop_var: flow_item
    index_var: flow_idx